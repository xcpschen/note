# 概述
memocache 是一个免费，源码开发，高性能，具备分布式缓存系统；可以把简单的数据缓存到内存里，例如字符串，对象等，以减少对数据库访问；本身是通过hashmap键值对存储方式。
## 存储过程
memocache，虽说是分布式缓存系统，但是集群间并不支持通信；所谓的分布式，依靠客户端程序的实现
```
    +-----------------------+
    |   application         |
    +-----------------------+

```
如同上述团，其一次写入流程：
1. 应用程序写入缓存
2. memocache客户端对key生成哈希值，利用该key使用路由算法，得出分布的节点ip地址
3. 得到目标存储ip地址，API调用通信模块和指定的服务器通信，写入数据，完成一次分布式缓存的写操作


## 路由算法
写入和读取是，都是通过路由算法获取目标操作节点。路由算法对于分布式实现很重要，如同负载均衡一样，通常memocahe支持的路由算法有两种`取余哈希`，`一致性哈希`
### 取余哈希
取余哈希，顾名思义，对哈希值按N取余数,而这N指定就是节点数目了。算法本身实现安全，但是对于扩容来说，执行期间容易丢失缓存，使得命中率降低呢，请求落到数据库里。

解决方案：
- 扩容时提前缓存数据到新的节点
- 低峰期操作

### 一致性哈希
所谓的一致性哈希算法，就是利用一个叫做一致性Hash环的数据结构实现Key到缓存服务器的Hash映射，其中：
- 该环节点共232个
- 节点名称的Hash值（其分布为[0, 231]）将缓存服务器节点放置在这个Hash环上
- Key的哈希值分区区间也在[0,231]的区间上

查找过程：
- 计算key的哈希值
- 在这个哈希环中，按`顺势针`查找最接近的节点，作为key的存储节点

新增节点时：`计算哈希值，存入hash环中`，相对于取余哈希算法来说，只会影响靠近改点的部分key数据，影响相对小点，这是他的优势.

这个长度为232的一致性Hash环通常使用二叉查找树实现
## 内存分配
memocache 采用allocator算法对数据内存进行分配管理；对分配的内存按大小划分出多类型，最大为1Mb，每一类的增长为1.25比例，可以在启动是指定比例`-f 倍数`，被分配的对象内存存储在chunk的结构体上;chunk由page划分而来，page是memocahe向操作系统的内存组织单位，最大1M；slob管理这从内存申请下来的page，slob下的page都是按相同大小划分的chunk，存放在slob_class数组上。
```
  +---------------+      +---------------+        +----------+
  | slob_class[0] |----->|    slob[1]    | ------>|  page    |
  +---------------+      +---------------+        +----------+
  | slob_class[1] |                              /              \
  +---------------+                             /                 \
  | slob_class[2] |                            +---+---+---+---+---+
  +---------------+                            |   |   |   |   |   |
  | slob_class[3] |                            +---+---+---+---+---+
  +---------------+                                   chunk
  | slob_class[.] |
  +---------------+
```
假设现在又一个88字节的对象需要内存，其内存分配流程如下：
- 对88字节求出最解决适合存放大小的chunk大小，确定slob_class的下标
- 根据下标，找到对应slob
  - 查找空闲的chunk,有的话返回
  - 没有的话，就需要申请page，对page切割成合适的chunk,选用第一个返回chunk

通过allocator进行根据对象大小分类内存管理，可以有效的减少碎片化；

值得注意的地方是：
- MemCache中可以保存的item数据量是没有限制的，只要内存足够
- 在32位机器上最高只能使用2GB的内存，64位没有限制；
- key的存储最大为250个字节，超过该长度无法存储
- 存储的对象最大也只能存储1M,超过不分配
- MemCache的LRU算法不是针对全局的，是针对slab的
- 如果没有足够的chunk时，系统启动是未设定`-M`来LRU算法清理缓冲的话，会出现OOM

## 总结
memocache 是个分布式缓存系统，但分布式得由客户端实现；且存储的对象不可以超过1M,数据类型也简单。两阶段的哈希是其高效性关键，第一阶段的哈希解决了节点分布问题，第二阶段哈希快速定位其内存位置。采用allocator管理内存分配，较为充分的利用小对象的特效，避免碎片化严重。