# 分区
kafka消息是按Topic组织，Topic存储时可被分区存储，分区存储则会带来，生产和消费带来不同的策略。

## 分区数设置
- 全局设定：server.properties配置文件中使用`num.partitions=xxx`,进行设定，默认为1
- 创建主题时设定：`--partitions number`

## 生产者消息投递
拥有分区时，生产投递消息的分区策略是：
- 发送指定分区，则消息投递到指定分区
- 没有指定分区，但是消息key不为空，则基于key的哈希值来选择一个分区
- 没有指定分区，消息key也为空，则轮询选择一个分区

## 消费者组分区分配
消费者以组的名义订阅主题，主题有多个分区，消费者组中有多个消费者实例，同一时刻分区只能被一个消费者实例消费。

消费者分区分配策略：
- range
  - 默认策略
  - 针对主题分区
  - 将分区按数字顺序排行序，消费者按消费者名称的字典序排好序
  - 用分区总数除以消费者总数。如果能够除尽，平均分配；若除不尽，则位于排序前面的消费者将多负责一个分区
- roundrobin 轮询
  - 基于所有可用的消费者和所有可用的分区的，分区按顺序分配，直到没有分区为止
  - 尽量均衡
- Sticky
  - 每一次分配变更相对上一次分配做最少的变动
    - 分区分配尽量均衡
    - 每一次重分配的结果尽量与上一次分配结果保持一致
  - 初始时按roundrobin，分配；消费者，或者分区变更时，采取最小变动的分区策略，减少操作

### 分区数与消费组数带来的问题
- 分区数大于消费组数
  - 一个消费者多消费个分区
- 分区数小于于消费组数
  - 默认策略下，存在空闲消费者，得不到消息